<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#6a3d7b" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>VOS Absensi</title>
    
    <!-- PWA Manifest with ID for dynamic injection -->
    <link rel="manifest" href="manifest.json" id="app-manifest">
    
    <!-- Script to dynamically update manifest icon based on Asset Logo from Supabase -->
    <script>
      (async function() {
        try {
          // 1. Default Local Asset Logo
          let logoUrl = "assets/vos-logo.png";

          // 2. Try Fetch from Supabase
          try {
             const supabaseUrl = 'https://mjumoowpjypshczjnlgp.supabase.co';
             const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qdW1vb3dwanlwc2hjempubGdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyMDAxMTIsImV4cCI6MjA4NDc3NjExMn0.f4_gJ7ncejQ4KVejyyicFaEsdCKzogAAkusvOuceaVc';
             
             const response = await fetch(`${supabaseUrl}/rest/v1/app_settings?key=eq.app_logo_url&select=value`, {
                headers: {
                   'apikey': supabaseKey,
                   'Authorization': `Bearer ${supabaseKey}`
                }
             });
             
             if (response.ok) {
                 const data = await response.json();
                 if (data && data.length > 0 && data[0].value) {
                    logoUrl = data[0].value;
                 }
             }
          } catch (err) {
             console.log("Using default logo (offline/error)", err);
          }

          // 3. Helper to set manifest
          const setManifest = (iconUrl) => {
            const manifestLink = document.getElementById('app-manifest');
            const type = "image/png";
            
            // CRITICAL FIX: start_url must be ABSOLUTE when using Blob manifest
            const appUrl = window.location.origin + window.location.pathname;

            const dynamicManifest = {
              "short_name": "VOS Absensi",
              "name": "Voice of Soul Attendance",
              "icons": [
                { "src": iconUrl, "sizes": "192x192", "type": type },
                { "src": iconUrl, "sizes": "512x512", "type": type }
              ],
              "start_url": appUrl, 
              "scope": appUrl,
              "display": "standalone",
              "theme_color": "#6a3d7b",
              "background_color": "#f8fafc",
              "orientation": "portrait"
            };
            
            const blob = new Blob([JSON.stringify(dynamicManifest)], {type: 'application/json'});
            manifestLink.href = URL.createObjectURL(blob);
            
            // Also update apple touch icon
            const appleIcon = document.getElementById('apple-icon');
            if (appleIcon) appleIcon.href = iconUrl;
          };

          // 4. Apply Asset Logo
          setManifest(logoUrl);

        } catch(e) { console.log('Error init manifest:', e); }
      })();
    </script>

    <link rel="apple-touch-icon" id="apple-icon" href="assets/vos-logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              purple: {
                50: '#f7f4f9',
                100: '#efe8f3',
                200: '#dfd2e7',
                300: '#c6b0d6',
                400: '#a885c0',
                500: '#8c5fa8',
                600: '#6a3d7b',
                700: '#583265',
                800: '#4a2b53',
                900: '#3d2444',
                950: '#26112c',
              }
            }
          }
        }
      }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/app.css">
    <script type="importmap">
    {
      "imports": {
        "react/": "https://esm.sh/react@^19.2.3/",
        "react": "https://esm.sh/react@^19.2.3",
        "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
        "react-router-dom": "https://esm.sh/react-router-dom@^7.12.0",
        "react-dom/": "https://esm.sh/react-dom@^19.2.3/"
      }
    }
    </script>
  <link rel="stylesheet" href="/index.css">
</head>
  <body class="bg-slate-50 text-slate-900">
    <div id="root"></div>
  <script type="module" src="/index.tsx"></script>
</body>
</html>